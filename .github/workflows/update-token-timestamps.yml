name: Update token timestamps

on:
  push:
    branches: [development]
    paths:
      - src/data/metrics.json
      - src/data/tokens.json

permissions:
  contents: write

jobs:
  update-token-timestamp:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Load secrets
        id: load-secrets
        uses: 1password/load-secrets-action@8d0d610af187e78a2772c2d18d627f4c52d3fbfb # v3.1.0
        with:
          export-env: false
        env:
          OP_SERVICE_ACCOUNT_TOKEN: "${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}"
          GPG_PASSPHRASE: op://kv_ownership-token-index_infra/arabot-1_SIGN_CERTS/credential
          GPG_PRIVATE_KEY: op://kv_ownership-token-index_infra/arabot-1_SIGN_CERTS/private_key

      - name: Checkout development
        uses: actions/checkout@v4
        with:
          ref: development
          fetch-depth: 0

      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@e89d40939c28e39f97cf32126055eeae86ba74ec # v6.3.0
        with:
          gpg_private_key: ${{ steps.load-secrets.outputs.GPG_PRIVATE_KEY }}
          passphrase: ${{ steps.load-secrets.outputs.GPG_PASSPHRASE }}
          git_user_signingkey: true
          git_commit_gpgsign: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Detect changed token ids
        id: changed
        run: |
          ids=$(node scripts/get-changed-token-ids.mjs --before "${{ github.event.before }}" --after "${{ github.event.after }}")
          echo "ids=$ids" >> $GITHUB_OUTPUT

      - name: Resolve commit timestamp
        id: timestamp
        run: |
          echo "value=$(node -e 'console.log(Math.floor(new Date(process.argv[1]).getTime() / 1000))' '${{ github.event.head_commit.timestamp }}')" >> $GITHUB_OUTPUT

      - name: Update timestamp
        if: steps.changed.outputs.ids != ''
        run: node scripts/update-token-timestamps.mjs --ids "${{ steps.changed.outputs.ids }}" --timestamp "${{ steps.timestamp.outputs.value }}"

      - name: Set commit message
        id: commit-message
        run: |
          echo "message=chore: update token lastUpdated" >> $GITHUB_OUTPUT

      - name: Commit and push
        run: |
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git add src/data/tokens.json
          git commit -am "${{ steps.commit-message.outputs.message }}"
          git push origin HEAD:development
